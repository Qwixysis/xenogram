<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xenogram - Final Fixed</title>
    <style>
        :root {
            --bg-main: #1e1e1e; --bg-side: #23272a; --bg-nav: #111111;
            --accent: #7289da; --accent-alt: #9b59b6; --danger: #f04747;
            --text-main: #ffffff; --text-dim: #b9bbbe;
            --grad: linear-gradient(135deg, #7289da, #9b59b6);
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: var(--bg-main); color: var(--text-main); overflow: hidden; }
        .app-container { display: flex; height: 100vh; width: 100vw; }

        .side-nav { width: 70px; background: var(--bg-nav); display: flex; flex-direction: column; align-items: center; padding-top: 15px; flex-shrink: 0; }
        .nav-icon { width: 48px; height: 48px; background: var(--bg-side); border-radius: 50%; margin-bottom: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.2s; }
        .nav-icon:hover { border-radius: 15px; background: var(--grad); }

        .chat-list { width: 300px; background: var(--bg-side); border-right: 1px solid #111; display: flex; flex-direction: column; }
        .list-header { padding: 20px; font-weight: bold; border-bottom: 1px solid #111; display: flex; justify-content: space-between; }
        
        .friend-item { padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #2f3136; }
        .friend-item:hover { background: #36393f; }
        .avatar-circle { width: 35px; height: 35px; border-radius: 50%; background: var(--grad); background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; font-weight: bold; overflow: hidden; flex-shrink: 0; }

        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .modal-content { background: var(--bg-side); width: 600px; height: 500px; border-radius: 12px; display: flex; overflow: hidden; }
        .modal-sidebar { width: 180px; background: #111; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .modal-main { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .modal-tab { cursor: pointer; color: var(--text-dim); padding: 8px; border-radius: 5px; }
        .modal-tab.active { background: #333; color: white; font-weight: bold; }
        
        input { background: #1e1e1e; border: 1px solid #444; color: white; padding: 12px; border-radius: 5px; margin-bottom: 15px; width: 100%; box-sizing: border-box; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; margin-bottom: 10px; }
        .btn-save { background: var(--accent); }
        .btn-danger { background: var(--danger); }

        .chat-window { flex-grow: 1; display: flex; flex-direction: column; }
        #messages-display { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 10px; border-radius: 10px; max-width: 70%; position: relative; }
        .msg.mine { align-self: flex-end; background: var(--accent); }
        .msg.theirs { align-self: flex-start; background: #32353b; }
        .msg-actions { display: none; position: absolute; top: -20px; right: 0; background: #111; padding: 5px; border-radius: 5px; font-size: 10px; cursor: pointer; }
        .msg:hover .msg-actions { display: block; }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="side-nav">
        <div class="nav-icon" id="open-chats">üí¨</div>
        <div class="nav-icon" id="open-social-btn">üë•</div>
        <div class="nav-icon" id="open-settings">‚öôÔ∏è</div>
        <div style="flex-grow: 1;"></div>
        <div class="nav-icon" id="logout-btn">üö™</div>
    </aside>

    <section class="chat-list">
        <div class="list-header">
            <span>Xenogram</span>
            <span style="cursor:pointer; color:var(--accent)" id="quick-add-friend">+</span>
        </div>
        <div id="friends-container"></div>
    </section>

    <main class="chat-window">
        <header style="padding: 20px; border-bottom: 1px solid #111; display: flex; justify-content: space-between; align-items: center;">
            <h3 id="chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
            <span id="target-uid-display" style="font-size: 10px; color: var(--text-dim); cursor: pointer;" title="–ù–∞–∂–º–∏, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å UID"></span>
        </header>
        <div id="messages-display"></div>
        <form id="message-form" style="padding: 20px; display: flex; gap: 10px;">
            <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled autocomplete="off">
            <button type="submit" style="display:none"></button>
        </form>
    </main>
</div>

<div id="social-modal" class="modal">
    <div class="modal-content">
        <div class="modal-sidebar">
            <h3 style="color:var(--accent)">–°–≤—è–∑—å</h3>
            <div class="modal-tab active" id="tab-add">–î–æ–±–∞–≤–∏—Ç—å</div>
            <div class="modal-tab" id="tab-pending">–ó–∞–ø—Ä–æ—Å—ã <span id="req-count"></span></div>
            <div style="flex-grow: 1"></div>
            <div class="modal-tab" id="close-social">–ó–∞–∫—Ä—ã—Ç—å</div>
        </div>
        <div class="modal-main" id="view-add">
            <h2>–ù–∞–π—Ç–∏ –¥—Ä—É–≥–∞</h2>
            <input type="text" id="search-uid" placeholder="–í–≤–µ–¥–∏—Ç–µ UID –¥—Ä—É–≥–∞...">
            <button class="btn btn-save" id="send-req">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
            <p style="font-size: 11px; color: var(--text-dim)">–í–∞—à UID: <br><b id="my-uid-val">–∑–∞–≥—Ä—É–∑–∫–∞...</b></p>
        </div>
        <div class="modal-main" id="view-pending" style="display:none">
            <h2>–í—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã</h2>
            <div id="req-list"></div>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal">
    <div class="modal-content">
        <div class="modal-sidebar">
            <h3 style="color:var(--accent-alt)">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <div class="modal-tab active" id="tab-profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
            <div class="modal-tab" id="tab-account">–ê–∫–∫–∞—É–Ω—Ç</div>
            <div style="flex-grow: 1"></div>
            <div class="modal-tab" id="close-settings">–ó–∞–∫—Ä—ã—Ç—å</div>
        </div>
        <div class="modal-main" id="view-profile">
            <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <input type="text" id="set-username" placeholder="–ù–∏–∫–Ω–µ–π–º">
            <input type="text" id="set-avatar" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∫–∏">
            <button class="btn btn-save" id="save-profile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div class="modal-main" id="view-account" style="display:none">
            <h2>–ê–∫–∫–∞—É–Ω—Ç</h2>
            <input type="email" id="set-email" placeholder="–ù–æ–≤—ã–π Email">
            <button class="btn btn-save" id="save-email">–°–º–µ–Ω–∏—Ç—å –ø–æ—á—Ç—É</button>
            <button class="btn btn-danger" id="delete-acc">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, onSnapshot, collection, addDoc, query, orderBy, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDqH9q3k1Ekl5KxxpBkFEm9OxgCtixshJY",
        authDomain: "xenogram-4a1c0.firebaseapp.com",
        projectId: "xenogram-4a1c0",
        storageBucket: "xenogram-4a1c0.firebasestorage.app",
        messagingSenderId: "219275152669",
        appId: "1:219275152669:web:ee7d63910d3a8e4ff065f4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentChatId = null;
    let unsubChat = null;

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    onAuthStateChanged(auth, async (user) => {
        if (!user) window.location.href = "auth.html";
        else {
            document.getElementById('my-uid-val').innerText = user.uid;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø—Ä–æ—Ñ–∏–ª—è –≤ –ë–î
            const uRef = doc(db, "users", user.uid);
            const uSnap = await getDoc(uRef);
            if(!uSnap.exists()) {
                await setDoc(uRef, { username: user.displayName || "User", friends: [], requests: [], avatar: "" });
            }
            loadAppData();
        }
    });

    function loadAppData() {
        // –°–ª—É—à–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π –∏ –∑–∞–ø—Ä–æ—Å—ã
        onSnapshot(doc(db, "users", auth.currentUser.uid), async (snap) => {
            const data = snap.data();
            if(!data) return;

            // –î—Ä—É–∑—å—è
            const container = document.getElementById('friends-container');
            container.innerHTML = "";
            for (const fId of (data.friends || [])) {
                const fDoc = await getDoc(doc(db, "users", fId));
                if(fDoc.exists()) {
                    const fData = fDoc.data();
                    const name = fData.username || "Unknown";
                    const item = document.createElement('div');
                    item.className = 'friend-item';
                    const avaStyle = fData.avatar ? `style="background-image:url(${fData.avatar}); color:transparent"` : "";
                    item.innerHTML = `<div class="avatar-circle" ${avaStyle}>${name[0].toUpperCase()}</div> <span>${name}</span>`;
                    item.onclick = () => startChat(fId, name);
                    container.appendChild(item);
                }
            }

            // –ó–∞–ø—Ä–æ—Å—ã
            const rList = document.getElementById('req-list');
            const reqs = data.requests || [];
            document.getElementById('req-count').innerText = reqs.length ? `(${reqs.length})` : "";
            rList.innerHTML = "";
            for (const rId of reqs) {
                const rDoc = await getDoc(doc(db, "users", rId));
                if(rDoc.exists()) {
                    const rData = rDoc.data();
                    const div = document.createElement('div');
                    div.className = 'friend-item';
                    div.style.justifyContent = "space-between";
                    div.innerHTML = `<span>${rData.username}</span> <button class="btn btn-save" style="margin:0" onclick="acceptFriend('${rId}')">–ü—Ä–∏–Ω—è—Ç—å</button>`;
                    rList.appendChild(div);
                }
            }
        });
    }

    // --- –°–ò–°–¢–ï–ú–ê –î–†–£–ó–ï–ô ---
    window.acceptFriend = async (fId) => {
        const myUid = auth.currentUser.uid;
        await updateDoc(doc(db, "users", myUid), { requests: arrayRemove(fId), friends: arrayUnion(fId) });
        await updateDoc(doc(db, "users", fId), { friends: arrayUnion(myUid) });
    };

    document.getElementById('send-req').onclick = async () => {
        const tid = document.getElementById('search-uid').value.trim();
        if(!tid || tid === auth.currentUser.uid) return;
        try {
            await updateDoc(doc(db, "users", tid), { requests: arrayUnion(auth.currentUser.uid) });
            alert("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
            document.getElementById('search-uid').value = "";
        } catch(e) { alert("ID –Ω–µ –Ω–∞–π–¥–µ–Ω"); }
    };

    // --- –ß–ê–¢ ---
    function startChat(id, name) {
        document.getElementById('chat-title').innerText = name;
        document.getElementById('message-input').disabled = false;
        document.getElementById('target-uid-display').innerText = id;
        currentChatId = [auth.currentUser.uid, id].sort().join('_');

        if(unsubChat) unsubChat();
        const q = query(collection(db, "chats", currentChatId, "messages"), orderBy("createdAt", "asc"));
        unsubChat = onSnapshot(q, (snap) => {
            const display = document.getElementById('messages-display');
            display.innerHTML = "";
            snap.forEach(m => {
                const d = m.data();
                const div = document.createElement('div');
                div.className = `msg ${d.uid === auth.currentUser.uid ? 'mine' : 'theirs'}`;
                div.innerHTML = `${d.text} <div class="msg-actions" onclick="deleteMsg('${m.id}')">–£–¥–∞–ª–∏—Ç—å</div>`;
                display.appendChild(div);
            });
            display.scrollTop = display.scrollHeight;
        });
    }

    window.deleteMsg = async (mId) => {
        if(confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) {
            await deleteDoc(doc(db, "chats", currentChatId, "messages", mId));
        }
    };

    document.getElementById('message-form').onsubmit = async (e) => {
        e.preventDefault();
        const inp = document.getElementById('message-input');
        if(!inp.value || !currentChatId) return;
        await addDoc(collection(db, "chats", currentChatId, "messages"), {
            text: inp.value,
            uid: auth.currentUser.uid,
            createdAt: serverTimestamp()
        });
        inp.value = "";
    };

    // --- –ú–û–î–ê–õ–ö–ò (–û–¢–ö–†–´–¢–ò–ï/–ó–ê–ö–†–´–¢–ò–ï) ---
    const sModal = document.getElementById('social-modal');
    const setModal = document.getElementById('settings-modal');
    
    document.getElementById('open-social-btn').onclick = () => sModal.style.display = 'flex';
    document.getElementById('quick-add-friend').onclick = () => sModal.style.display = 'flex';
    document.getElementById('close-social').onclick = () => sModal.style.display = 'none';
    
    document.getElementById('open-settings').onclick = () => setModal.style.display = 'flex';
    document.getElementById('close-settings').onclick = () => setModal.style.display = 'none';

    // –¢–∞–±—ã
    document.getElementById('tab-pending').onclick = () => {
        document.getElementById('view-add').style.display='none'; document.getElementById('view-pending').style.display='block';
        document.getElementById('tab-pending').classList.add('active'); document.getElementById('tab-add').classList.remove('active');
    };
    document.getElementById('tab-add').onclick = () => {
        document.getElementById('view-add').style.display='block'; document.getElementById('view-pending').style.display='none';
        document.getElementById('tab-add').classList.add('active'); document.getElementById('tab-pending').classList.remove('active');
    };

    // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
    document.getElementById('save-profile').onclick = async () => {
        const n = document.getElementById('set-username').value;
        const a = document.getElementById('set-avatar').value;
        await updateProfile(auth.currentUser, { displayName: n, photoURL: a });
        await updateDoc(doc(db, "users", auth.currentUser.uid), { username: n, avatar: a });
        alert("–û–±–Ω–æ–≤–ª–µ–Ω–æ!");
    };

    document.getElementById('logout-btn').onclick = () => signOut(auth);
</script>
</body>
</html>
