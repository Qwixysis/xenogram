<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xenogram - Social</title>
    <style>
        :root {
            --bg-main: #1e1e1e; --bg-side: #23272a; --bg-nav: #111111;
            --accent: #7289da; --accent-alt: #9b59b6;
            --text-main: #ffffff; --text-dim: #b9bbbe;
            --grad: linear-gradient(135deg, #7289da, #9b59b6);
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: var(--bg-main); color: var(--text-main); overflow: hidden; }
        .app-container { display: flex; height: 100vh; width: 100vw; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .side-nav { width: 70px; background: var(--bg-nav); display: flex; flex-direction: column; align-items: center; padding-top: 15px; flex-shrink: 0; }
        .nav-icon { width: 48px; height: 48px; background: var(--bg-side); border-radius: 50%; margin-bottom: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.2s; }
        .nav-icon:hover { border-radius: 15px; background: var(--grad); }

        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        .chat-list { width: 300px; background: var(--bg-side); border-right: 1px solid #111; display: flex; flex-direction: column; }
        .list-header { padding: 20px; font-weight: bold; border-bottom: 1px solid #111; display: flex; justify-content: space-between; }
        .add-friend-btn { cursor: pointer; color: var(--accent); font-size: 20px; }

        .friend-item { padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #2f3136; transition: 0.2s; }
        .friend-item:hover { background: #36393f; }
        .avatar-circle { width: 35px; height: 35px; border-radius: 50%; background: var(--grad); display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background: var(--bg-side); width: 500px; height: 400px; border-radius: 12px; display: flex; overflow: hidden; }
        .modal-sidebar { width: 150px; background: #111; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .modal-main { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; }
        .modal-tab { cursor: pointer; color: var(--text-dim); }
        .modal-tab.active { color: white; font-weight: bold; }
        
        .request-item { background: #2f3136; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .btn-accept { background: #43b581; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        
        input { background: #1e1e1e; border: 1px solid #444; color: white; padding: 10px; border-radius: 5px; margin-bottom: 10px; }

        /* –ß–∞—Ç */
        .chat-window { flex-grow: 1; display: flex; flex-direction: column; }
        #messages-display { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 10px; max-width: 70%; font-size: 15px; }
        .msg.mine { align-self: flex-end; background: var(--accent); }
        .msg.theirs { align-self: flex-start; background: #32353b; }

        #message-form { padding: 20px; display: flex; gap: 10px; }
        #message-input { flex-grow: 1; border-radius: 8px; border: none; padding: 12px; background: #40444b; color: white; }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="side-nav">
        <div class="nav-icon" title="–ß–∞—Ç—ã">üí¨</div>
        <div class="nav-icon" id="open-social" title="–°–æ—Ü–∏–∞–ª—å–Ω–æ–µ">üë•</div>
        <div style="flex-grow: 1;"></div>
        <div class="nav-icon" id="logout-btn">üö™</div>
    </aside>

    <section class="chat-list">
        <div class="list-header">
            <span>–î—Ä—É–∑—å—è</span>
            <span class="add-friend-btn" id="open-modal-btn">+</span>
        </div>
        <div id="friends-container"></div>
    </section>

    <main class="chat-window">
        <header id="chat-header" style="padding: 20px; border-bottom: 1px solid #111;">
            <h3 id="chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
        </header>
        <div id="messages-display"></div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
            <button type="submit" style="display:none"></button>
        </form>
    </main>
</div>

<div id="friend-modal" class="modal">
    <div class="modal-content">
        <div class="modal-sidebar">
            <div class="modal-tab active" id="tab-add">–î–æ–±–∞–≤–∏—Ç—å</div>
            <div class="modal-tab" id="tab-pending">–û–∂–∏–¥–∞–Ω–∏–µ <span id="req-count"></span></div>
            <div style="flex-grow: 1"></div>
            <div class="modal-tab" id="close-modal">–ó–∞–∫—Ä—ã—Ç—å</div>
        </div>
        <div class="modal-main" id="modal-view-add">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</h2>
            <p style="font-size: 12px; color: var(--text-dim)">–í–≤–µ–¥–∏ UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</p>
            <input type="text" id="target-uid" placeholder="–ù–∞–ø—Ä: aBc123Xyz...">
            <button id="send-request-btn" class="btn-accept" style="background: var(--accent)">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
        </div>
        <div class="modal-main" id="modal-view-pending" style="display: none;">
            <h2>–í—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã</h2>
            <div id="requests-list"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDqH9q3k1Ekl5KxxpBkFEm9OxgCtixshJY",
        authDomain: "xenogram-4a1c0.firebaseapp.com",
        projectId: "xenogram-4a1c0",
        storageBucket: "xenogram-4a1c0.firebasestorage.app",
        messagingSenderId: "219275152669",
        appId: "1:219275152669:web:ee7d63910d3a8e4ff065f4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentChatId = null;
    let unsubscribeChat = null;

    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "auth.html";
        else {
            initApp();
        }
    });

    function initApp() {
        const userRef = doc(db, "users", auth.currentUser.uid);
        
        // –°–ª—É—à–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥—Ä—É–∑—å—è –∏ –∑–∞–ø—Ä–æ—Å—ã)
        onSnapshot(userRef, async (snap) => {
            const data = snap.data();
            if (!data) return;

            // 1. –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π
            const friendsList = document.getElementById('friends-container');
            friendsList.innerHTML = "";
            for (const fId of (data.friends || [])) {
                const fDoc = await getDoc(doc(db, "users", fId));
                if (fDoc.exists()) {
                    const fData = fDoc.data();
                    const initial = fData.username ? fData.username[0].toUpperCase() : "?";
                    const item = document.createElement('div');
                    item.className = 'friend-item';
                    item.innerHTML = `<div class="avatar-circle">${initial}</div> <span>${fData.username}</span>`;
                    item.onclick = () => startChat(fId, fData.username);
                    friendsList.appendChild(item);
                }
            }

            // 2. –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å—ã
            const reqList = document.getElementById('requests-list');
            const reqs = data.requests || [];
            document.getElementById('req-count').innerText = reqs.length > 0 ? `(${reqs.length})` : "";
            reqList.innerHTML = "";
            for (const rId of reqs) {
                const rDoc = await getDoc(doc(db, "users", rId));
                const rData = rDoc.data();
                const div = document.createElement('div');
                div.className = 'request-item';
                div.innerHTML = `<span>${rData.username}</span> <button class="btn-accept" onclick="acceptFriend('${rId}')">–ü—Ä–∏–Ω—è—Ç—å</button>`;
                reqList.appendChild(div);
            }
        });
    }

    // –õ–æ–≥–∏–∫–∞ –º–æ–¥–∞–ª–∫–∏
    const modal = document.getElementById('friend-modal');
    document.getElementById('open-modal-btn').onclick = () => modal.style.display = 'flex';
    document.getElementById('close-modal').onclick = () => modal.style.display = 'none';
    
    document.getElementById('tab-add').onclick = () => {
        document.getElementById('modal-view-add').style.display = 'block';
        document.getElementById('modal-view-pending').style.display = 'none';
        document.getElementById('tab-add').classList.add('active');
        document.getElementById('tab-pending').classList.remove('active');
    };
    
    document.getElementById('tab-pending').onclick = () => {
        document.getElementById('modal-view-add').style.display = 'none';
        document.getElementById('modal-view-pending').style.display = 'block';
        document.getElementById('tab-pending').classList.add('active');
        document.getElementById('tab-add').classList.remove('active');
    };

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
    document.getElementById('send-request-btn').onclick = async () => {
        const target = document.getElementById('target-uid').value.trim();
        if (!target || target === auth.currentUser.uid) return;
        
        try {
            await updateDoc(doc(db, "users", target), {
                requests: arrayUnion(auth.currentUser.uid)
            });
            alert("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
            document.getElementById('target-uid').value = "";
        } catch (e) { alert("–û—à–∏–±–∫–∞! –ü—Ä–æ–≤–µ—Ä—å UID."); }
    };

    // –ü—Ä–∏–Ω—è—Ç–∏–µ –¥—Ä—É–≥–∞
    window.acceptFriend = async (fId) => {
        const myUid = auth.currentUser.uid;
        // 1. –£–±–∏—Ä–∞–µ–º –∏–∑ –∑–∞–ø—Ä–æ—Å–æ–≤
        await updateDoc(doc(db, "users", myUid), { 
            requests: arrayRemove(fId),
            friends: arrayUnion(fId) 
        });
        // 2. –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è –∫ –¥—Ä—É–≥—É
        await updateDoc(doc(db, "users", fId), { 
            friends: arrayUnion(myUid) 
        });
    };

    // –ß–∞—Ç
    function startChat(fId, fName) {
        document.getElementById('chat-title').innerText = fName;
        document.getElementById('message-input').disabled = false;
        const chatID = [auth.currentUser.uid, fId].sort().join('_');
        currentChatId = chatID;

        if (unsubscribeChat) unsubscribeChat();
        const q = query(collection(db, "chats", chatID, "messages"), orderBy("createdAt", "asc"));
        unsubscribeChat = onSnapshot(q, (snap) => {
            const disp = document.getElementById('messages-display');
            disp.innerHTML = "";
            snap.forEach(m => {
                const d = m.data();
                const div = document.createElement('div');
                div.className = `msg ${d.uid === auth.currentUser.uid ? 'mine' : 'theirs'}`;
                div.innerText = d.text;
                disp.appendChild(div);
            });
            disp.scrollTop = disp.scrollHeight;
        });
    }

    document.getElementById('message-form').onsubmit = async (e) => {
        e.preventDefault();
        const inp = document.getElementById('message-input');
        if (!inp.value || !currentChatId) return;
        await addDoc(collection(db, "chats", currentChatId, "messages"), {
            text: inp.value,
            uid: auth.currentUser.uid,
            createdAt: serverTimestamp()
        });
        inp.value = "";
    };

    document.getElementById('logout-btn').onclick = () => signOut(auth);
</script>
</body>
</html>
