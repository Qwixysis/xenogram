<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, arrayUnion, arrayRemove, onSnapshot, collection, addDoc, query, orderBy, serverTimestamp, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDqH9q3k1Ekl5KxxpBkFEm9OxgCtixshJY",
        authDomain: "xenogram-4a1c0.firebaseapp.com",
        projectId: "xenogram-4a1c0",
        storageBucket: "xenogram-4a1c0.firebasestorage.app",
        messagingSenderId: "219275152669",
        appId: "1:219275152669:web:ee7d63910d3a8e4ff065f4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentChatId = null, myNick = "", selectedMsgId = null, isEditing = false, viewedFriendId = null, unsubMsg = null, unsubTyping = null;

    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "auth.html";
        } else {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            const userRef = doc(db, "users", user.uid);
            const userSnap = await getDoc(userRef);
            
            if (!userSnap.exists()) {
                // –ï—Å–ª–∏ –∑–∞—à–ª–∏ —á–µ—Ä–µ–∑ —Å–æ—Ü—Å–µ—Ç—å –∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ —Å–æ–∑–¥–∞–ª—Å—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                await setDoc(userRef, {
                    username: user.displayName || "User",
                    avatar: "",
                    friends: [],
                    requests: [],
                    groups: [],
                    isOnline: true,
                    lastSeen: serverTimestamp()
                });
            } else {
                await updateDoc(userRef, { isOnline: true, lastSeen: serverTimestamp() });
            }

            const d = (await getDoc(userRef)).data();
            myNick = d?.username || "User";
            document.getElementById('my-uid-val').innerText = user.uid;
            document.getElementById('set-nick').value = myNick;
            document.getElementById('set-ava').value = d?.avatar || "";
            initApp();
        }
    });

    function initApp() {
        // –ì–ª–∞–≤–Ω—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        onSnapshot(doc(db, "users", auth.currentUser.uid), async (snap) => {
            const data = snap.data(); if(!data) return;
            
            // –°–ø–∏—Å–∫–∏ –¥—Ä—É–∑–µ–π –∏ –≥—Ä—É–ø–ø
            const fCont = document.getElementById('friends-container');
            const cgList = document.getElementById('grp-friends-select');
            fCont.innerHTML = ""; cgList.innerHTML = "";

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ì—Ä—É–ø–ø
            for(const gId of (data.groups || [])) {
                const gDoc = await getDoc(doc(db, "chats", gId));
                if(gDoc.exists()){
                    const d = document.createElement('div'); d.className = 'friend-item';
                    d.innerHTML = `<div class="avatar-circle" style="background:var(--accent-alt)">G</div><span>${gDoc.data().groupName}</span>`;
                    d.onclick = () => window.startChat(gId, gDoc.data().groupName, true);
                    fCont.appendChild(d);
                }
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –î—Ä—É–∑–µ–π
            for(const fId of (data.friends || [])) {
                const fDoc = await getDoc(doc(db, "users", fId));
                if(fDoc.exists()){
                    const fd = fDoc.data();
                    const div = document.createElement('div'); div.className = 'friend-item';
                    div.innerHTML = `
                        <div class="avatar-circle" ${fd.avatar?`style="background-image:url(${fd.avatar})"`:''}>
                            ${fd.avatar?'':fd.username[0]}${fd.isOnline?'<div class="online-badge"></div>':''}
                        </div>
                        <span class="friend-name-text">${fd.username}</span>
                        <div class="friend-controls">
                            <div class="ctrl-btn" title="–ß–∞—Ç" onclick="window.startChat('${fId}', '${fd.username}', false)">üí¨</div>
                            <div class="ctrl-btn" title="–ü—Ä–æ—Ñ–∏–ª—å" onclick="window.openFriendProfile('${fId}')">‚ÑπÔ∏è</div>
                        </div>
                    `;
                    fCont.appendChild(div);
                    cgList.innerHTML += `<label style="display:block"><input type="checkbox" value="${fId}"> ${fd.username}</label>`;
                }
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ó–∞–ø—Ä–æ—Å–æ–≤ (–û–∂–∏–¥–∞–Ω–∏–µ)
            const rCont = document.getElementById('req-list'); 
            rCont.innerHTML = (data.requests || []).length === 0 ? "<p style='color:gray;text-align:center'>–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</p>" : "";
            
            for(const rId of (data.requests || [])) {
                const rDoc = await getDoc(doc(db, "users", rId));
                if(rDoc.exists()) {
                    const rd = rDoc.data();
                    const rDiv = document.createElement('div');
                    rDiv.className = 'friend-item';
                    rDiv.style.justifyContent = "space-between";
                    rDiv.innerHTML = `
                        <span>${rd.username}</span>
                        <button class="btn" onclick="window.acceptFriend('${rId}')">–ü—Ä–∏–Ω—è—Ç—å</button>
                    `;
                    rCont.appendChild(rDiv);
                }
            }
        });
    }

    // --- –ü–£–ë–õ–ò–ß–ù–´–ï –§–£–ù–ö–¶–ò–ò (–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è HTML) ---

    window.acceptFriend = async (id) => {
        try {
            const myId = auth.currentUser.uid;
            await updateDoc(doc(db, "users", myId), { requests: arrayRemove(id), friends: arrayUnion(id) });
            await updateDoc(doc(db, "users", id), { friends: arrayUnion(myId) });
            alert("–î—Ä—É–≥ –¥–æ–±–∞–≤–ª–µ–Ω!");
        } catch (e) { alert("–û—à–∏–±–∫–∞: " + e.message); }
    };

    window.startChat = (id, name, isGroup) => {
        currentChatId = isGroup ? id : [auth.currentUser.uid, id].sort().join('_');
        document.getElementById('chat-title').innerText = name;
        document.getElementById('message-input').disabled = false;
        document.getElementById('app-wrap').classList.add('chat-open');

        if(unsubTyping) unsubTyping();
        unsubTyping = onSnapshot(doc(db, "chats", currentChatId), (s) => {
            const t = s.data()?.typing || {};
            const active = Object.keys(t).filter(uid => uid !== auth.currentUser.uid && t[uid] === true);
            document.getElementById('typing-indicator').style.opacity = active.length > 0 ? 1 : 0;
        });

        const d = document.getElementById('messages-display'); d.innerHTML = "";
        if(unsubMsg) unsubMsg();
        unsubMsg = onSnapshot(query(collection(db, "chats", currentChatId, "messages"), orderBy("createdAt", "asc")), (snap) => {
            d.innerHTML = "";
            snap.forEach(doc => {
                const m = doc.data(); if(!m) return;
                const mine = m.uid === auth.currentUser.uid;
                const time = m.createdAt ? new Date(m.createdAt.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
                const mDiv = document.createElement('div');
                mDiv.className = `msg ${mine?'mine':'theirs'}`;
                mDiv.innerHTML = `<div class="msg-meta">${m.sender}${m.edited?'<span class="edited-tag">(–∏–∑–º.)</span>':''}</div><div>${m.text}</div><div class="msg-time">${time}</div>`;
                if(mine) mDiv.onclick = (e) => showActions(e, doc.id, m.text);
                d.appendChild(mDiv);
            });
            d.scrollTop = d.scrollHeight;
        });
    };

    window.openFriendProfile = async (id) => {
        viewedFriendId = id;
        const s = await getDoc(doc(db, "users", id));
        if(!s.exists()) return;
        const d = s.data();
        document.getElementById('friend-profile-name').innerText = d.username;
        document.getElementById('friend-profile-uid').innerText = id;
        const ava = document.getElementById('friend-profile-ava');
        ava.style.backgroundImage = d.avatar ? `url(${d.avatar})` : 'none';
        ava.innerText = d.avatar ? '' : d.username[0];
        document.getElementById('modal-friend-profile').style.display = 'flex';
    };

    window.switchSocial = (v) => {
        ['add','req','grp'].forEach(id => document.getElementById('view-'+id).style.display = id===v?'block':'none');
        // –°–±—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞ –≤ —Ç–∞–±–∞—Ö
        document.querySelectorAll('.modal-tab').forEach(t => {
            t.classList.remove('active');
            if(t.innerText.toLowerCase().includes(v === 'add' ? '–ø–æ–∏—Å–∫' : v === 'req' ? '–∑–∞–ø—Ä–æ—Å—ã' : '–≥—Ä—É–ø–ø–∞')) t.classList.add('active');
        });
    };

    window.closeModals = () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    window.toggleBurger = () => {
        const side = document.getElementById('side-nav');
        const isOpen = side.classList.toggle('open');
        document.getElementById('nav-overlay').style.display = isOpen ? 'block' : 'none';
    };

    // –°–ª—É—à–∞—Ç–µ–ª–∏ –∫–Ω–æ–ø–æ–∫
    document.getElementById('btn-send-req').onclick = async () => {
        const targetId = document.getElementById('search-uid').value.trim();
        if(!targetId) return;
        if(targetId === auth.currentUser.uid) return alert("–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è!");
        
        try {
            const targetRef = doc(db, "users", targetId);
            const targetSnap = await getDoc(targetRef);
            if(!targetSnap.exists()) return alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!");
            
            await updateDoc(targetRef, { requests: arrayUnion(auth.currentUser.uid) });
            alert("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
            document.getElementById('search-uid').value = "";
        } catch(e) { alert("–û—à–∏–±–∫–∞: " + e.message); }
    };

    document.getElementById('btn-unfriend').onclick = async () => {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π?")) {
            const myId = auth.currentUser.uid;
            await updateDoc(doc(db, "users", myId), { friends: arrayRemove(viewedFriendId) });
            await updateDoc(doc(db, "users", viewedFriendId), { friends: arrayRemove(myId) });
            closeModals();
        }
    };

    document.getElementById('btn-save-prof').onclick = async () => {
        const n = document.getElementById('set-nick').value;
        const a = document.getElementById('set-ava').value;
        await updateDoc(doc(db, "users", auth.currentUser.uid), { username: n, avatar: a });
        alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
        closeModals();
    };

    document.getElementById('logout-btn').onclick = () => signOut(auth);
    document.getElementById('open-social').onclick = () => document.getElementById('modal-social').style.display = 'flex';
    document.getElementById('open-settings').onclick = () => document.getElementById('modal-settings').style.display = 'flex';
    document.getElementById('mobile-back').onclick = () => document.getElementById('app-wrap').classList.remove('chat-open');

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ —É —Ç–µ–±—è
    const msgInp = document.getElementById('message-input');
    // ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ msgInp.oninput, onkeydown –∏ —Ç.–¥. –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        </script>
        
