<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xenogram - Final</title>
    <style>
        :root {
            --bg-main: #1e1e1e; --bg-side: #23272a; --bg-nav: #111111;
            --accent: #7289da; --accent-alt: #9b59b6; --danger: #f04747;
            --text-main: #ffffff; --text-dim: #b9bbbe;
            --grad: linear-gradient(135deg, #7289da, #9b59b6);
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: var(--bg-main); color: var(--text-main); overflow: hidden; }
        .app-container { display: flex; height: 100vh; width: 100vw; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .side-nav { width: 70px; background: var(--bg-nav); display: flex; flex-direction: column; align-items: center; padding-top: 15px; flex-shrink: 0; }
        .nav-icon { width: 48px; height: 48px; background: var(--bg-side); border-radius: 50%; margin-bottom: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.2s; }
        .nav-icon:hover { border-radius: 15px; background: var(--grad); }

        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        .chat-list { width: 300px; background: var(--bg-side); border-right: 1px solid #111; display: flex; flex-direction: column; }
        .list-header { padding: 20px; font-weight: bold; border-bottom: 1px solid #111; display: flex; justify-content: space-between; }
        
        .friend-item { padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #2f3136; }
        .avatar-circle { width: 35px; height: 35px; border-radius: 50%; background: var(--grad); background-size: cover; display: flex; align-items: center; justify-content: center; font-weight: bold; overflow: hidden; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .modal-content { background: var(--bg-side); width: 600px; height: 500px; border-radius: 12px; display: flex; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .modal-sidebar { width: 180px; background: #111; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .modal-main { flex-grow: 1; padding: 30px; display: flex; flex-direction: column; overflow-y: auto; }
        .modal-tab { cursor: pointer; color: var(--text-dim); padding: 8px; border-radius: 5px; }
        .modal-tab.active { background: #333; color: white; font-weight: bold; }
        
        input { background: #1e1e1e; border: 1px solid #444; color: white; padding: 12px; border-radius: 5px; margin-bottom: 15px; width: 100%; box-sizing: border-box; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; margin-bottom: 10px; }
        .btn-save { background: var(--accent); }
        .btn-danger { background: var(--danger); }

        /* –ß–∞—Ç */
        .chat-window { flex-grow: 1; display: flex; flex-direction: column; }
        #messages-display { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 10px; border-radius: 10px; max-width: 70%; }
        .msg.mine { align-self: flex-end; background: var(--accent); }
        .msg.theirs { align-self: flex-start; background: #32353b; }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="side-nav">
        <div class="nav-icon" title="–ß–∞—Ç—ã">üí¨</div>
        <div class="nav-icon" id="open-social" title="–î—Ä—É–∑—å—è">üë•</div>
        <div class="nav-icon" id="open-settings" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</div>
        <div style="flex-grow: 1;"></div>
        <div class="nav-icon" id="logout-btn">üö™</div>
    </aside>

    <section class="chat-list">
        <div class="list-header">
            <span>Xenogram</span>
            <span style="cursor:pointer; color:var(--accent)" id="open-add-friend">+</span>
        </div>
        <div id="friends-container"></div>
    </section>

    <main class="chat-window">
        <header style="padding: 20px; border-bottom: 1px solid #111;"><h3 id="chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3></header>
        <div id="messages-display"></div>
        <form id="message-form" style="padding: 20px; display: flex; gap: 10px;">
            <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
        </form>
    </main>
</div>

<div id="settings-modal" class="modal">
    <div class="modal-content">
        <div class="modal-sidebar">
            <h3 style="color:var(--accent-alt)">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <div class="modal-tab active" id="tab-profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
            <div class="modal-tab" id="tab-account">–ê–∫–∫–∞—É–Ω—Ç</div>
            <div style="flex-grow: 1"></div>
            <div class="modal-tab" id="close-settings">–ó–∞–∫—Ä—ã—Ç—å</div>
        </div>
        <div class="modal-main" id="view-profile">
            <h2>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <label>–ù–∏–∫–Ω–µ–π–º:</label>
            <input type="text" id="set-username" placeholder="–ù–æ–≤—ã–π –Ω–∏–∫">
            <label>–ê–≤–∞—Ç–∞—Ä–∫–∞ (URL):</label>
            <input type="text" id="set-avatar" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ">
            <button class="btn btn-save" id="save-profile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>
        <div class="modal-main" id="view-account" style="display:none">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</h2>
            <label>–ù–æ–≤–∞—è –ø–æ—á—Ç–∞:</label>
            <input type="email" id="set-email" placeholder="email@example.com">
            <button class="btn btn-save" id="save-email">–°–º–µ–Ω–∏—Ç—å –ø–æ—á—Ç—É</button>
            <hr style="border:0; border-top:1px solid #444; margin: 20px 0;">
            <button class="btn btn-danger" id="delete-account">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –Ω–∞–≤—Å–µ–≥–¥–∞</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateEmail, updateProfile, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, onSnapshot, collection, addDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDqH9q3k1Ekl5KxxpBkFEm9OxgCtixshJY",
        authDomain: "xenogram-4a1c0.firebaseapp.com",
        projectId: "xenogram-4a1c0",
        storageBucket: "xenogram-4a1c0.firebasestorage.app",
        messagingSenderId: "219275152669",
        appId: "1:219275152669:web:ee7d63910d3a8e4ff065f4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- –õ–û–ì–ò–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê –ù–ê–°–¢–†–û–ï–ö ---
    const sModal = document.getElementById('settings-modal');
    document.getElementById('open-settings').onclick = () => sModal.style.display = 'flex';
    document.getElementById('close-settings').onclick = () => sModal.style.display = 'none';

    document.getElementById('tab-profile').onclick = () => {
        document.getElementById('view-profile').style.display = 'block';
        document.getElementById('view-account').style.display = 'none';
        document.getElementById('tab-profile').classList.add('active');
        document.getElementById('tab-account').classList.remove('active');
    };

    document.getElementById('tab-account').onclick = () => {
        document.getElementById('view-profile').style.display = 'none';
        document.getElementById('view-account').style.display = 'block';
        document.getElementById('tab-account').classList.add('active');
        document.getElementById('tab-profile').classList.remove('active');
    };

    // --- –°–û–•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• ---
    document.getElementById('save-profile').onclick = async () => {
        const newNick = document.getElementById('set-username').value;
        const newAva = document.getElementById('set-avatar').value;
        const user = auth.currentUser;

        try {
            await updateProfile(user, { displayName: newNick, photoURL: newAva });
            await updateDoc(doc(db, "users", user.uid), { username: newNick, avatar: newAva });
            alert("–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!");
        } catch (e) { alert(e.message); }
    };

    document.getElementById('save-email').onclick = async () => {
        const newEmail = document.getElementById('set-email').value;
        try {
            await updateEmail(auth.currentUser, newEmail);
            alert("–ü–æ—á—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∞!");
        } catch (e) { alert("–ù—É–∂–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è."); }
    };

    document.getElementById('delete-account').onclick = async () => {
        if(confirm("–í–´ –£–í–ï–†–ï–ù–´? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å—ë –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.")) {
            try {
                await deleteUser(auth.currentUser);
                window.location.href = "auth.html";
            } catch (e) { alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è."); }
        }
    };

    // --- –û–°–ù–û–í–ù–ê–Ø –†–ê–ë–û–¢–ê –ß–ê–¢–ê ---
    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "auth.html";
        else {
            document.getElementById('set-username').value = user.displayName || "";
            document.getElementById('set-avatar').value = user.photoURL || "";
            loadFriends();
        }
    });

    async function loadFriends() {
        onSnapshot(doc(db, "users", auth.currentUser.uid), async (snap) => {
            const friendsList = document.getElementById('friends-container');
            friendsList.innerHTML = "";
            const data = snap.data();
            for (const fId of (data.friends || [])) {
                const fDoc = await getDoc(doc(db, "users", fId));
                const fData = fDoc.data();
                const item = document.createElement('div');
                item.className = 'friend-item';
                const styleAva = fData.avatar ? `style="background-image:url(${fData.avatar}); color:transparent"` : "";
                item.innerHTML = `<div class="avatar-circle" ${styleAva}>${fData.username[0]}</div> <span>${fData.username}</span>`;
                item.onclick = () => startChat(fId, fData.username);
                friendsList.appendChild(item);
            }
        });
    }

    let currentChatId = null;
    let unsub = null;

    function startChat(id, name) {
        document.getElementById('chat-title').innerText = name;
        document.getElementById('message-input').disabled = false;
        currentChatId = [auth.currentUser.uid, id].sort().join('_');
        if(unsub) unsub();
        const q = query(collection(db, "chats", currentChatId, "messages"), orderBy("createdAt", "asc"));
        unsub = onSnapshot(q, (snap) => {
            const d = document.getElementById('messages-display');
            d.innerHTML = "";
            snap.forEach(m => {
                const data = m.data();
                const div = document.createElement('div');
                div.className = `msg ${data.uid === auth.currentUser.uid ? 'mine' : 'theirs'}`;
                div.innerText = data.text;
                d.appendChild(div);
            });
            d.scrollTop = d.scrollHeight;
        });
    }

    document.getElementById('message-form').onsubmit = async (e) => {
        e.preventDefault();
        const inp = document.getElementById('message-input');
        if(!inp.value) return;
        await addDoc(collection(db, "chats", currentChatId, "messages"), {
            text: inp.value,
            uid: auth.currentUser.uid,
            createdAt: serverTimestamp()
        });
        inp.value = "";
    };

    document.getElementById('logout-btn').onclick = () => signOut(auth);
</script>
</body>
</html>
