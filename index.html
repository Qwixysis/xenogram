<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xenogram - Final Fixed Name</title>
    <style>
        :root {
            --bg-main: #1e1e1e; --bg-side: #23272a; --bg-nav: #111111;
            --accent: #7289da; --accent-alt: #9b59b6; --danger: #f04747;
            --text-main: #ffffff; --text-dim: #b9bbbe;
            --grad: linear-gradient(135deg, #7289da, #9b59b6);
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: var(--bg-main); color: var(--text-main); overflow: hidden; }
        .app-container { display: flex; height: 100vh; width: 100vw; }

        /* –ë–æ–∫–æ–≤–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
        .side-nav { width: 70px; background: var(--bg-nav); display: flex; flex-direction: column; align-items: center; padding-top: 15px; flex-shrink: 0; }
        .nav-icon { width: 48px; height: 48px; background: var(--bg-side); border-radius: 50%; margin-bottom: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.2s; }
        .nav-icon:hover { border-radius: 15px; background: var(--grad); }

        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        .chat-list { width: 300px; background: var(--bg-side); border-right: 1px solid #111; display: flex; flex-direction: column; }
        .list-header { padding: 20px; font-weight: bold; border-bottom: 1px solid #111; display: flex; justify-content: space-between; align-items: center; }
        
        .friend-item { padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #2f3136; }
        .friend-item:hover { background: #36393f; }
        .avatar-circle { width: 35px; height: 35px; border-radius: 50%; background: var(--grad); background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }

        /* –û–∫–Ω–æ —á–∞—Ç–∞ */
        .chat-window { flex-grow: 1; display: flex; flex-direction: column; }
        .chat-header { padding: 15px 20px; border-bottom: 1px solid #111; display: flex; justify-content: space-between; align-items: center; background: var(--bg-main); }
        #messages-display { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .msg { padding: 10px 14px; border-radius: 12px; max-width: 65%; position: relative; }
        .msg.mine { align-self: flex-end; background: var(--accent); border-bottom-right-radius: 2px; }
        .msg.theirs { align-self: flex-start; background: #32353b; border-bottom-left-radius: 2px; }
        .msg-sender { font-size: 11px; font-weight: bold; margin-bottom: 4px; color: var(--accent-alt); }
        .mine .msg-sender { color: #fff; opacity: 0.8; }
        .msg-text { font-size: 14px; line-height: 1.4; word-wrap: break-word; }

        /* –ú–æ–¥–∞–ª–∫–∏ */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .modal-content { background: var(--bg-side); width: 550px; height: 450px; border-radius: 12px; display: flex; overflow: hidden; }
        .modal-sidebar { width: 160px; background: #111; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .modal-main { flex-grow: 1; padding: 25px; overflow-y: auto; }
        .modal-tab { cursor: pointer; color: var(--text-dim); padding: 10px; border-radius: 6px; font-size: 14px; }
        .modal-tab.active { background: #333; color: white; font-weight: bold; }
        
        input { background: #1e1e1e; border: 1px solid #444; color: white; padding: 12px; border-radius: 6px; margin-bottom: 15px; width: 100%; box-sizing: border-box; outline: none; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; }
        .btn-save { background: var(--accent); width: 100%; }

        #message-form { padding: 15px 20px; background: var(--bg-main); display: flex; gap: 10px; }
        #message-input { margin-bottom: 0; background: #40444b; border: none; }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="side-nav">
        <div class="nav-icon" title="–ß–∞—Ç—ã">üí¨</div>
        <div class="nav-icon" id="open-social-btn" title="–°–æ—Ü–∏–∞–ª—å–Ω–æ–µ">üë•</div>
        <div class="nav-icon" id="open-settings" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</div>
        <div style="flex-grow: 1;"></div>
        <div class="nav-icon" id="logout-btn" title="–í—ã–π—Ç–∏">üö™</div>
    </aside>

    <section class="chat-list">
        <div class="list-header">
            <span>Xenogram</span>
            <span style="cursor:pointer; color:var(--accent); font-size: 24px;" id="quick-add">+</span>
        </div>
        <div id="friends-container"></div>
    </section>

    <main class="chat-window">
        <header class="chat-header">
            <h3 id="chat-title" style="margin:0">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
            <span id="target-uid-display" style="font-size: 10px; color: var(--text-dim)"></span>
        </header>
        <div id="messages-display"></div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å..." disabled autocomplete="off">
            <button type="submit" style="display:none"></button>
        </form>
    </main>
</div>

<div id="social-modal" class="modal">
    <div class="modal-content">
        <div class="modal-sidebar">
            <h3 style="color:var(--accent)">–°–≤—è–∑—å</h3>
            <div class="modal-tab active" id="tab-add">–ù–∞–π—Ç–∏ –¥—Ä—É–≥–∞</div>
            <div class="modal-tab" id="tab-pending">–ó–∞–ø—Ä–æ—Å—ã <span id="req-count"></span></div>
            <div style="flex-grow: 1"></div>
            <div class="modal-tab" id="close-social">–ó–∞–∫—Ä—ã—Ç—å</div>
        </div>
        <div class="modal-main" id="view-add">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –ø–æ UID</h2>
            <input type="text" id="search-uid" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ UID...">
            <button class="btn btn-save" id="send-req">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
            <p style="font-size: 11px; margin-top: 20px;">–í–∞—à UID: <br><code id="my-uid-display" style="color:var(--accent-alt)">...</code></p>
        </div>
        <div class="modal-main" id="view-pending" style="display:none">
            <h2>–í—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã</h2>
            <div id="req-list"></div>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal">
    <div class="modal-content">
        <div class="modal-sidebar">
            <h3 style="color:var(--accent-alt)">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <div class="modal-tab active">–ü—Ä–æ—Ñ–∏–ª—å</div>
            <div style="flex-grow: 1"></div>
            <div class="modal-tab" id="close-settings">–ó–∞–∫—Ä—ã—Ç—å</div>
        </div>
        <div class="modal-main">
            <h2>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <label style="font-size: 12px; color: var(--text-dim)">–ù–∏–∫–Ω–µ–π–º:</label>
            <input type="text" id="set-username" placeholder="–í–∞—à –Ω–∏–∫">
            <label style="font-size: 12px; color: var(--text-dim)">–ê–≤–∞—Ç–∞—Ä (URL):</label>
            <input type="text" id="set-avatar" placeholder="https://...">
            <button class="btn btn-save" id="save-profile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, onSnapshot, collection, addDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDqH9q3k1Ekl5KxxpBkFEm9OxgCtixshJY",
        authDomain: "xenogram-4a1c0.firebaseapp.com",
        projectId: "xenogram-4a1c0",
        storageBucket: "xenogram-4a1c0.firebasestorage.app",
        messagingSenderId: "219275152669",
        appId: "1:219275152669:web:ee7d63910d3a8e4ff065f4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentChatId = null;
    let currentUserName = "User";

    // --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "auth.html";
        } else {
            document.getElementById('my-uid-display').innerText = user.uid;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤ Firestore
            const uRef = doc(db, "users", user.uid);
            const uSnap = await getDoc(uRef);
            
            if (!uSnap.exists()) {
                const name = user.displayName || "–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
                await setDoc(uRef, { username: name, friends: [], requests: [], avatar: "" });
                currentUserName = name;
            } else {
                currentUserName = uSnap.data().username || "User";
            }
            
            document.getElementById('set-username').value = currentUserName;
            document.getElementById('set-avatar').value = uSnap.data()?.avatar || "";
            
            initAppListeners();
        }
    });

    function initAppListeners() {
        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–≤–æ–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è (–¥—Ä—É–∑—å—è, –Ω–∏–∫, –∑–∞–ø—Ä–æ—Å—ã)
        onSnapshot(doc(db, "users", auth.currentUser.uid), async (snap) => {
            const data = snap.data();
            if (!data) return;

            currentUserName = data.username || "User";

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥—Ä—É–∑–µ–π
            const friendsCont = document.getElementById('friends-container');
            friendsCont.innerHTML = "";
            for (const fId of (data.friends || [])) {
                const fDoc = await getDoc(doc(db, "users", fId));
                if (fDoc.exists()) {
                    const fData = fDoc.data();
                    const name = fData.username || "–î—Ä—É–≥";
                    const item = document.createElement('div');
                    item.className = 'friend-item';
                    const ava = fData.avatar ? `style="background-image:url(${fData.avatar}); color:transparent"` : "";
                    item.innerHTML = `<div class="avatar-circle" ${ava}>${name[0].toUpperCase()}</div> <span>${name}</span>`;
                    item.onclick = () => startChat(fId, name);
                    friendsCont.appendChild(item);
                }
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
            const reqCont = document.getElementById('req-list');
            const reqs = data.requests || [];
            document.getElementById('req-count').innerText = reqs.length ? `(${reqs.length})` : "";
            reqCont.innerHTML = "";
            for (const rId of reqs) {
                const rDoc = await getDoc(doc(db, "users", rId));
                if (rDoc.exists()) {
                    const rData = rDoc.data();
                    const div = document.createElement('div');
                    div.className = 'friend-item';
                    div.style.justifyContent = "space-between";
                    div.innerHTML = `<span>${rData.username}</span> <button class="btn btn-save" style="width:auto" onclick="acceptFriend('${rId}')">–î–∞</button>`;
                    reqCont.appendChild(div);
                }
            }
        });
    }

    // --- –ß–ê–¢ ---
    let unsubChat = null;
    function startChat(id, name) {
        document.getElementById('chat-title').innerText = name;
        document.getElementById('message-input').disabled = false;
        document.getElementById('target-uid-display').innerText = `ID: ${id}`;
        currentChatId = [auth.currentUser.uid, id].sort().join('_');

        if (unsubChat) unsubChat();
        const q = query(collection(db, "chats", currentChatId, "messages"), orderBy("createdAt", "asc"));
        
        unsubChat = onSnapshot(q, (snap) => {
            const disp = document.getElementById('messages-display');
            disp.innerHTML = "";
            snap.forEach(m => {
                const d = m.data();
                const isMine = d.uid === auth.currentUser.uid;
                const div = document.createElement('div');
                div.className = `msg ${isMine ? 'mine' : 'theirs'}`;
                div.innerHTML = `
                    <div class="msg-sender">${d.senderName || "User"}</div>
                    <div class="msg-text">${d.text}</div>
                `;
                disp.appendChild(div);
            });
            disp.scrollTop = disp.scrollHeight;
        });
    }

    document.getElementById('message-form').onsubmit = async (e) => {
        e.preventDefault();
        const inp = document.getElementById('message-input');
        if (!inp.value || !currentChatId) return;

        await addDoc(collection(db, "chats", currentChatId, "messages"), {
            text: inp.value,
            uid: auth.currentUser.uid,
            senderName: currentUserName, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∏–º—è
            createdAt: serverTimestamp()
        });
        inp.value = "";
    };

    // --- –§–£–ù–ö–¶–ò–ò ---
    window.acceptFriend = async (fId) => {
        const myUid = auth.currentUser.uid;
        await updateDoc(doc(db, "users", myUid), { requests: arrayRemove(fId), friends: arrayUnion(fId) });
        await updateDoc(doc(db, "users", fId), { friends: arrayUnion(myUid) });
    };

    document.getElementById('send-req').onclick = async () => {
        const tid = document.getElementById('search-uid').value.trim();
        if (!tid || tid === auth.currentUser.uid) return;
        try {
            await updateDoc(doc(db, "users", tid), { requests: arrayUnion(auth.currentUser.uid) });
            alert("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
            document.getElementById('search-uid').value = "";
        } catch(e) { alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω."); }
    };

    document.getElementById('save-profile').onclick = async () => {
        const newNick = document.getElementById('set-username').value.trim();
        const newAva = document.getElementById('set-avatar').value.trim();
        if(!newNick) return;

        await updateProfile(auth.currentUser, { displayName: newNick, photoURL: newAva });
        await updateDoc(doc(db, "users", auth.currentUser.uid), { username: newNick, avatar: newAva });
        currentUserName = newNick;
        alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
    };

    // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–û–î–ê–õ–ö–ê–ú–ò ---
    const sMod = document.getElementById('social-modal');
    const setMod = document.getElementById('settings-modal');

    document.getElementById('open-social-btn').onclick = () => sMod.style.display = 'flex';
    document.getElementById('quick-add').onclick = () => sMod.style.display = 'flex';
    document.getElementById('close-social').onclick = () => sMod.style.display = 'none';
    document.getElementById('open-settings').onclick = () => setMod.style.display = 'flex';
    document.getElementById('close-settings').onclick = () => setMod.style.display = 'none';

    document.getElementById('tab-pending').onclick = () => {
        document.getElementById('view-add').style.display = 'none';
        document.getElementById('view-pending').style.display = 'block';
        document.getElementById('tab-pending').classList.add('active');
        document.getElementById('tab-add').classList.remove('active');
    };
    document.getElementById('tab-add').onclick = () => {
        document.getElementById('view-add').style.display = 'block';
        document.getElementById('view-pending').style.display = 'none';
        document.getElementById('tab-add').classList.add('active');
        document.getElementById('tab-pending').classList.remove('active');
    };

    document.getElementById('logout-btn').onclick = () => signOut(auth);
</script>
</body>
</html>
